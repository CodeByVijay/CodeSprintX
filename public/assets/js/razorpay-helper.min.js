let razorpayScriptLoaded=!1;let razorpayLoadPromise=null;function loadRazorpayScript(){if(razorpayLoadPromise){return razorpayLoadPromise}
if(typeof Razorpay!=='undefined'){razorpayScriptLoaded=!0;return Promise.resolve()}
razorpayLoadPromise=new Promise((resolve,reject)=>{console.log('Loading Razorpay script...');const script=document.createElement('script');script.src='https://checkout.razorpay.com/v1/checkout.js';script.async=!0;script.defer=!0;script.onload=function(){console.log('✅ Razorpay script loaded successfully');razorpayScriptLoaded=!0;resolve()};script.onerror=function(error){console.error('❌ Failed to load Razorpay script',error);razorpayLoadPromise=null;reject(new Error('Failed to load the payment gateway script. Please check your internet connection.'))};document.head.appendChild(script)});return razorpayLoadPromise}
function withRazorpay(callback){if(typeof Razorpay==='function'){callback();return}
loadRazorpayScript().then(callback).catch(error=>{console.error('Error in withRazorpay:',error);const retry=confirm('Unable to load payment gateway. Would you like to try again?');if(retry){razorpayLoadPromise=null;withRazorpay(callback)}})}
function initializeRazorpay(options,maxAttempts=3){let attempts=0;function attemptInit(){return new Promise((resolve,reject)=>{attempts++;console.log(`Attempt ${attempts} to initialize Razorpay`);if(typeof Razorpay!=='function'){console.log('Razorpay not available yet, loading script...');loadRazorpayScript().then(()=>{if(attempts<maxAttempts){setTimeout(()=>{attemptInit().then(resolve).catch(reject)},1000)}else{reject(new Error('Failed to load Razorpay after multiple attempts'))}}).catch(reject);return}
console.log('Creating Razorpay instance with options:',{key:options.key,order_id:options.order_id,amount:options.amount,currency:options.currency});try{const rzp=new Razorpay(options);rzp.on('payment.success',function(response){console.log('Payment successful via event handler:',response);resolve(response)});rzp.on('payment.error',function(error){console.error('Payment error via event handler:',error);reject(error)});rzp.open();console.log('✅ Razorpay checkout opened successfully');resolve(rzp)}catch(error){console.error('❌ Error initializing Razorpay:',error);if(attempts<maxAttempts){console.log(`Retrying... (${attempts}/${maxAttempts})`);setTimeout(()=>{attemptInit().then(resolve).catch(reject)},1000)}else{reject(error)}}})}
return attemptInit()}
loadRazorpayScript().catch(error=>{console.warn('Preloading Razorpay script failed:',error);console.log('Will try again when payment is initiated')})
